<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:p="http://primefaces.org/ui">
	<h:form id="form">
	<table>
		<tbody>
			<tr>
				<td><h:outputText value="Название задачи:"/></td>
				<td><p:inputText id="objectName" value="#{userTask.object.name}" required="true" requiredMessage="Поле не может быть пустым"/></td>
				<td><p:message for="objectName" display="text"/></td>
			</tr>
			<tr>
				<td><h:outputText value="Описание:"/></td>
				<td><p:inputTextarea id="objectDescription" value="#{userTask.object.description}" rows="5" required="true" requiredMessage="Поле не может быть пустым" autoResize="false"/></td>
				<td><p:message for="objectDescription" display="text"/></td>
			</tr>
			<tr>
				<td><h:outputText value="Автор:"/></td>
				<td><h:outputText value="#{userTask.object.createdBy.fullName}"/></td>
			</tr>
			<ui:fragment rendered="#{userTask.object.id == 0}">
				<tr>
					<td><h:outputText value="Категория контроля для задачи:"/></td>
					<td>
						<p:selectOneMenu value="#{userTask.object.cCategory}" id="objectControlCategory">
							<f:selectItems value="#{userTask.categories}" var="cat" itemLabel="#{cat.description}" itemValue="#{cat}"/>
							<p:ajax update="changeableAttributes" event="change"/>
						</p:selectOneMenu>
					</td>
					<td><p:message for="objectControlCategory" display="text" /></td>
				</tr>
			</ui:fragment>
			<ui:fragment rendered="#{userTask.object.id != 0}">
				<tr>
					<td><h:outputText value="Категория контроля для задачи:"/></td>
					<td><h:outputText value="#{userTask.object.cCategory.description}"/></td>
				</tr>
			</ui:fragment>
		</tbody>
	</table>
	<p:outputPanel id="changeableAttributes">
			<ui:fragment rendered="#{!empty userTask.object.cCategory and (userTask.object.cCategory.cc1 or userTask.object.cCategory.cc2 or userTask.object.cCategory.cc3)}">
			<table>
			<tbody>
				<tr>
				<td><h:outputText value="Распорядитель ресурсов:"/></td>
				<td>
					<p:selectOneMenu value="#{userTask.selectedResourceManager}" id="objectResourceManager" required="true" requiredMessage="Необходимо выбрать распорядителя ресурсов">
						<f:selectItem itemLabel="Выберите пользователя" />
						<f:selectItems value="#{userTask.userList}" var="u" itemLabel="#{u.fullName}" itemValue="#{u.userLoginName}"/>
					</p:selectOneMenu>
				</td>
				<td><p:message for="objectResourceManager" display="text"/></td>
			</tr>
			<tr>
				<td><h:outputText value="Куратор:"/></td>
				<td>
					<p:selectOneMenu value="#{userTask.selectedCurator}" id="objectCurator">
						<f:selectItem itemLabel="Выберите пользователя" />
						<f:selectItems value="#{userTask.userList}" var="u" itemLabel="#{u.fullName}" itemValue="#{u.userLoginName}"/>
					</p:selectOneMenu>
				</td>
				<td><p:message for="objectCurator" display="text"/></td>
			</tr>
			<tr>
				<td><h:outputText value="Ответственный исполнитель:"/></td>
				<td>
					<p:selectOneMenu value="#{userTask.selectedPerformer}" id="objectPerformer">
						<f:selectItem itemLabel="Выберите пользователя" />
						<f:selectItems value="#{userTask.userList}" var="u" itemLabel="#{u.fullName}" itemValue="#{u.userLoginName}"/>
					</p:selectOneMenu>
				</td>
				<td><p:message for="objectPerformer" display="text"/></td>
			</tr>
			<tr>
				<td><h:outputText value="Контролер:"/></td>
				<td>
					<p:selectOneMenu value="#{userTask.selectedController}" id="objectController">
						<f:selectItem itemLabel="Выберите пользователя" />
						<f:selectItems value="#{userTask.userList}" var="u" itemLabel="#{u.fullName}" itemValue="#{u.userLoginName}"/>
					</p:selectOneMenu>
				</td>
				<td><p:message for="objectController" display="text"/></td>
			</tr>
				<tr>
					<td><h:outputText value="Дата начала работы над задачей:"/></td>
					<td><p:calendar id="startProcessDate" value="#{userTask.object.startProcessDate}" mode="popup"
                    		readOnlyInputText="true" mindate="#{userTask.currentDate}" maxdate="#{userTask.object.endProcessDate}"> 
          					<p:ajax event="dateSelect" update="endProcessDate"/>
        				</p:calendar>
        			</td>
        			<td><p:message for="startProcessDate" display="text"/></td>
				</tr>
				<tr>
					<td><h:outputText value="Дата окончания работы над задачей:"/></td>
					<td><p:calendar id="endProcessDate" value="#{userTask.object.endProcessDate}" mode="popup"
                    		readOnlyInputText="true" mindate="#{userTask.object.startProcessDate}" disabled="#{userTask.object.startProcessDate == null}"> 
          					<p:ajax event="dateSelect" update="startProcessDate"/>
        				</p:calendar>
        			</td>
        			<td><p:message for="endProcessDate" display="text"/></td>
				</tr>
				</tbody>
				</table>
				</ui:fragment>	
			</p:outputPanel>
		<p:commandButton onclick="modalInputDocuments.show();" value="Перечень входных документов" type="button"/>
       	<p:commandButton onclick="modalOutputDocuments.show();" value="Перечень выходных документов" type="button"/>
        <p:commandButton value="Создать задачу" action="#{userTask.addObject}" ajax="false"/>
        </h:form>
        <p:dialog widgetVar="modalInputDocuments" header="Перечень входных документов" modal="true" resizable="false">
		<h:form>
		
		<p:outputPanel autoUpdate="true">
			<p:dataTable value="#{userTask.object.revisions[0].inputDocumentRevisions}" var="documentRevision" paginator="true"
                         rows="5" emptyMessage="Документов не найдено" paginatorPosition="bottom">
				<p:column>
					<f:facet name="header">
						<h:outputText value="Номер документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.cItem.id}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Название документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.cItem.name}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="КК документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.cItem.cCategory.label}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Автор документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.cItem.createdBy.fullName}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Версия документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.id}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Статус версии документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.state.label}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Автор версии документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.createdBy.fullName}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Дата создания версии"/>
					</f:facet>
					<h:outputText value="#{documentRevision.formattedCreatedAtDate}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Действие"/>
					</f:facet>
					<p:commandButton action="#{userTask.deleteInputDocument(documentRevision)}" value="удалить" />
				</p:column>
			</p:dataTable>
		</p:outputPanel>
		<p:commandButton onclick="modalInputDocuments.hide();" value="Закрыть" type="button"/>
		<p:commandButton onclick="modalSearch.show();" value="Добавить документ" type="button"/>
		</h:form>
	</p:dialog>
	<p:dialog widgetVar="modalOutputDocuments" header="Перечень выходных документов" modal="true" resizable="false">
		<h:form>
		
		<p:outputPanel autoUpdate="true">
			<p:dataTable value="#{userTask.object.revisions[0].outputDocumentRevisions}" var="documentRevision" paginator="true"
                         rows="5" emptyMessage="Документов не найдено" paginatorPosition="bottom">
				<p:column>
					<f:facet name="header">
						<h:outputText value="Номер документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.cItem.id}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Название документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.cItem.name}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="КК документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.cItem.cCategory.label}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Автор документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.cItem.createdBy.fullName}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Версия документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.id}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Статус версии документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.state.label}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Автор версии документа"/>
					</f:facet>
					<h:outputText value="#{documentRevision.createdBy.fullName}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Дата создания версии"/>
					</f:facet>
					<h:outputText value="#{documentRevision.formattedCreatedAtDate}"/>
				</p:column>
				<p:column>
					<f:facet name="header">
						<h:outputText value="Действие"/>
					</f:facet>
					<p:commandButton action="#{userTask.deleteOutputDocument(documentRevision)}" value="удалить" />
				</p:column>
			</p:dataTable>
		</p:outputPanel>
		<p:commandButton onclick="modalOutputDocuments.hide();" value="Закрыть" type="button"/>
		<p:commandButton onclick="modalAddDocument.show();" value="Добавить документ" type="button"/>
		</h:form>
	</p:dialog>
</ui:composition>